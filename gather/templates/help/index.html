{% extends 'base.html'%}
{% load staticfiles %}
{% block title %}
<title>Gather-聚</title>
{% endblock %}

{% block extra_css %}
<style type="text/css">
    .help-search{
        background: none repeat scroll 0 0 #333;
        border-radius: 5px;
        bottom: 0;
        box-shadow: 3px 3px 3px #666 inset;
        left: 0;
        opacity: 0.8;
        padding: 10px;
        position: fixed;
        width: 25%;
    }
    .help-bottom{
        background: none repeat scroll 0 0 #333;
        border-radius: 5px;
        bottom: 0;
        box-shadow: 3px 3px 3px #666 inset;
        left: 0;
        opacity: 0.8;
        padding: 10px;
        position: fixed;
        width: 60%;
        margin-left: 20%
    }
    body{
        overflow-y: hidden; 
    }
</style>
{% endblock %}

{% block container %}
 <div id="map"></div>

<input type="hidden" value="{{ latitude|default:'116.404' }}" id="init_x"/>
<input type="hidden" value="{{ longitude|default:'39.915'}}" id="init_y"/>

 <div class="help-search">
    <span class="label label-info" style="font-size:15px;">搜</span>
    <input type="text" id="suggestId" size="20" value="百度" style="width:180px;font-color: black;margin-left:0px;" />
    <div id="searchResultPanel" style="border:1px solid #C0C0C0;width:150px;height:auto; display:none;"></div>
</div>

 <div class="help-bottom text-right">
    <div class="text-left" style="position:absolute;margin-left:200px;">
    <span class="label label-danger" id="x_bottom"></span><br/>
    <span class="label label-danger" id="y_bottom"></span>
    </div>
    <button class="btn btn-success" style="margin-right:150px;" data-toggle="modal" data-target="#myModal" id="help_btn">发布求助</button>
 </div>

<!-- 添加拜托信息 -->
 <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">拜托拜托~</h4>
        <span class="label label-danger" id="x"></span>
        <span class="label label-danger" id="y"></span>
        <span></span>
      </div>
      <form action="{% url 'help_add' %}" method="post">
        {% csrf_token %}
          <div class="modal-body">
             <div class="form-group">
                <label>标题</label>
                <input type="text" class="form-control" placeholder="简短描述拜托" name="title"/>
              </div>
              <div class="form-group">
                <label>求助内容</label>
                <textarea class="form-control" rows="3" placeholder="请输入要拜托的内容" name="content"></textarea>
              </div>
              <div class="form-group">
                <label>失效日期</label>
                <input type="text" class="form-control" placeholder="空则为长期有效" name="cancel_time"/>
              </div>
              <div class="form-group">
                <label>联系方式</label>
                <input type="text" class="form-control" placeholder="电话、qq、email" name="connect_method"/>
              </div>
               <div class="form-group">
                <label>备注</label>
                <input type="text" class="form-control" placeholder="备注" name="remark"/>
               </div>
               <input type="hidden" value="" name="longitude" id="longitude"/>
               <input type="hidden" value="" name="latitude" id="latitude"/>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            <button type="submit" class="btn btn-primary">提交</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- 显示拜托信息 -->
<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">拜托拜托~</h4>
        <span class="label label-default" id="help_longitude"></span>
        <span class="label label-default" id="help_latitude"></span>
        <span></span>
      </div>
      <div class="modal-body">
          <div class="form-group">
            <label>求助内容:</label>
            <label id="help_content"></label>
          </div>
          <div class="form-group">
            <label>失效日期:</label>
            <label id="help_cancel_time"></label>
          </div>
          <div class="form-group">
            <label>联系方式:</label>
            <label id="help_connect_method"></label>
          </div>
           <div class="form-group">
            <label>备注:</label>
            <label id="help_remark"></label>
           </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info" data-dismiss="modal">去帮助</button>
        <button type="button" class="btn btn-default" data-dismiss="modal" class="close">关闭</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=9YHq6ry1x8dptH7God0GnteU"></script>
<script type="text/javascript">
    $("#map").css('height', window.screen.availHeight - 90);
    $("#map").css('width', window.screen.availWidth);
    $(".help-search").css('margin-bottom', window.screen.availHeight * 0.7);
    $(".help-search").css('margin-left', window.screen.availWidth * 0.8);

    var map = new BMap.Map("map");

    // 进入时焦点位置；第一次进入为默认，其他为发布拜托后位置
    var init_x = parseFloat($("#init_x").val());
    var init_y = parseFloat($("#init_y").val());
    map.centerAndZoom(new BMap.Point(init_x, init_y), 15);

    window.onload = get_location;
    function get_location(){
        // 获取所有拜托的位置
        $.ajax({
            url: '/help/points/',
            type: 'GET',
            dataType: 'json',
            success: function(Data) {
                if(Data['result']){
                    var json_data = Data['points'];
                    var pointArray = new Array();
                    for(var i=0;i<json_data.length;i++){
                        var marker = new BMap.Marker(new BMap.Point(json_data[i][0], json_data[i][1])); // 创建点
                        map.addOverlay(marker);    //增加点
                        pointArray[i] = new BMap.Point(json_data[i][0], json_data[i][1]);
                        help_id= json_data[i][2];
                        marker.addEventListener("click", function(){
                            $.ajax({
                                url: '/help/detail/' + help_id + '/',
                                type: 'GET',
                                dataType: 'json',
                                data: {},
                                success: function(Data){
                                    if(Data['result']){
                                        $("#help_longitude").html("经度" + Data['longitude']);
                                        $("#help_latitude").html("维度" + Data['latitude']);
                                        $("#help_title").html(Data['title']);
                                        $("#help_content").html(Data['content']);
                                        $("#help_remark").html(Data['remark']);
                                        $("#help_connect_method").html(Data['connect_method']);
                                        $("#help_cancel_time").html(Data['cancel_time']);
                                        $("#helpModal").removeClass('fade').addClass('show');
                                    }else{
                                        alert("拜托详情错误, 请刷新");
                                    }
                                }
                            })
                        });
                    }
                    //让所有点在视野范围内
                    map.setViewport(pointArray);
                }
            }
        })
        .fail(function() {
            alert("获取地点加载失败, 请刷新");
        })
    }

    /*
     * 放大缩小的标尺
     */ 
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
    var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
    //添加控件和比例尺
    map.addControl(top_left_control);        
    map.addControl(top_left_navigation);     

    /*
     *  添加定位控件
     */ 
    var geolocationControl = new BMap.GeolocationControl();
    map.addControl(geolocationControl);

    /*
     * 点击事件
     */
    function showInfo(e){
        $("#x").html("经度" + e.point.lng)
        $("#y").html("维度" + e.point.lat)

        $("#longitude").val(e.point.lng)
        $("#latitude").val(e.point.lat)

        $("#x_bottom").html("经度" + e.point.lng)
        $("#y_bottom").html("维度" + e.point.lat)
    }
    map.addEventListener("click", showInfo);

    /*
     * 地图地点搜索
     */
    // 百度地图API功能
    function G(id) {
        return document.getElementById(id);
    }

    var ac = new BMap.Autocomplete(    //建立一个自动完成的对象
        {"input" : "suggestId"
        ,"location" : map
    });

    ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
    var str = "";
        var _value = e.fromitem.value;
        var value = "";
        if (e.fromitem.index > -1) {
            value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        }    
        str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;
        
        value = "";
        if (e.toitem.index > -1) {
            _value = e.toitem.value;
            value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        }    
        str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
        G("searchResultPanel").innerHTML = str;
    });

    var myValue;
    ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
    var _value = e.item.value;
        myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
        G("searchResultPanel").innerHTML ="onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;
        
        setPlace();
    });

    function setPlace(){
        map.clearOverlays();    //清除地图上所有覆盖物
        function myFun(){
            var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
            map.centerAndZoom(pp, 18);
            map.addOverlay(new BMap.Marker(pp));    //添加标注
        }
        var local = new BMap.LocalSearch(map, { //智能搜索
          onSearchComplete: myFun
        });
        local.search(myValue);
    }

    /* 
     * bootstrap modal 关闭按钮, 隐藏modal
     */
     $(".class").click(function(){
        $(".modal").removeClass('show').addClass('fade');
     });

</script>
{% endblock %}